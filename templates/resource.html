{% extends "base.html" %}
{% load i18n %}

{% block head %}
<link rel='stylesheet' type='text/css' href='{{ STATIC_URL }}cal/fullcalendar.css' />
<link rel='stylesheet' type='text/css' href='{{ STATIC_URL }}cal/fullcalendar.print.css' media='print' />
<script type='text/javascript' src='{{ STATIC_URL }}cal/fullcalendar.js'></script>
<script>
    function onDayClick(date, allDay, jsEvent, view) {
	var theData = {};
	theData['timestamp'] = date.getTime()/1000;
	theData['resource_id'] = {{ resource.id }}
	$.ajax({
	    url: "{% url single_click_reservation %}",
	    type: "POST",
	    dataType: "json",
	    data: theData,
	    }).done(function() {
		$('#calendar').fullCalendar('refetchEvents');
	    }).fail(showAjaxFailure);
    }

    function deleteEvent(eventId) {
	n = noty({
	    text: "Do you want to remove event #" + eventId,
	    type: 'error',
	    dismissQueue: true,
	    layout: 'center',
	    buttons: [
	    {
		addClass: 'btn btn-danger', text: 'Delete', onClick: function($noty) {
		    $noty.close();
		    $.ajax({
			url: "{% url delete_reservation %}",
			type: "POST",
			dataType: "json",
			data: {id: eventId},
			}).done(function() {
			    $('#calendar').fullCalendar('refetchEvents');
			}).fail(showAjaxFailure);
		}
	    },
	    {
		addClass: 'btn btn-primary', text: 'Cancel', onClick: function($noty) {
		    $noty.close();
		    $('#calendar').fullCalendar('refetchEvents');
		}

	    }]
	});
    }

    function showEventInfo(calEvent) {
	<!-- TODO -->
    }

    function onEventClick(calEvent, jsEvent, view) {
	if (calEvent.is_own) {
	    deleteEvent(calEvent.id);
	} else {
	    showEventInfo(calEvent);
	}
    }

    function initialize() {
	$('#calendar').fullCalendar({
	    firstDay: 1,
	    defaultView: 'agendaWeek',
	    editable: true,
	    disableResizing: true,
	    allDayDefault: false,
	    allDaySlot: false,
	    defaultEventMinutes: 60,
	    firstHour: 10,
	    columnFormat: 'ddd d/M',
	    titleFormat: {
		month: 'MMMM yyyy',                             // September 2009
		week: "MMM d[',' yyyy]{ '&#8212;'[ MMM] d',' yyyy}", // Sep 7 - 13 2009
		day: 'dddd, MMM d, yyyy'                  // Tuesday, Sep 8, 2009
	    },
	    eventSources: [{url: "{% url reservations resource.id %}"}],
	    dayClick: onDayClick,
	    eventClick: onEventClick
	});

	map = initializeMap("map_canvas", {{ resource.latitude }}, {{ resource.longitude }});
	addArrowIcon(map,
	    {{ resource.latitude }},
	    {{ resource.longitude }},
	    "{{ STATIC_URL }}images/down.png",
	    "{{ resource.name }}",
	    "{% url resource resource.id %}");

	{% for r in resources %}
	addResourceIcon(map,
	    {{ r.latitude }},
	    {{ r.longitude }},
	    "{{ r.image_url }}",
	    "{{ r.name }}",
	    "{% url resource r.id %}");
	{% endfor %}
    }

    $(document).ready(initialize);
</script>
{% endblock %}

{% block content %}
Showing resource {{ resource.name }} with id {{ resource.id }}.
<div id="map_canvas"></div>
<div id="calendar"></div>
{% endblock %}
